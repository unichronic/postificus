services:
  # -------------------------------------------------------
  # 1. THE API SERVER
  # -------------------------------------------------------
  - type: web
    name: postificus-api
    env: docker
    plan: free
    dockerContext: .
    dockerfilePath: deploy/Dockerfile.api
    healthCheckPath: /health
    numInstances: 1
    region: oregon
    envVars:
      - key: APP_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: postificus-db
          property: connectionString
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: postificus-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: pserv
          name: postificus-redis
          property: port
      - key: RABBITMQ_HOST
        fromService:
          type: pserv
          name: postificus-rabbitmq
          property: host
      - key: RABBITMQ_PORT
        fromService:
          type: pserv
          name: postificus-rabbitmq
          property: port

  # -------------------------------------------------------
  # 2. THE WORKER (Background Jobs)
  # -------------------------------------------------------
  - type: worker
    name: postificus-worker
    env: docker
    dockerContext: .
    dockerfilePath: deploy/Dockerfile.worker
    envVars:
      - key: APP_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: postificus-db
          property: connectionString
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: postificus-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: pserv
          name: postificus-redis
          property: port
      - key: RABBITMQ_HOST
        fromService:
          type: pserv
          name: postificus-rabbitmq
          property: host
      - key: RABBITMQ_PORT
        fromService:
          type: pserv
          name: postificus-rabbitmq
          property: port

  # -------------------------------------------------------
  # 3. RABBITMQ (Private Docker Service - Ephemeral)
  # -------------------------------------------------------
  - type: pserv
    name: postificus-rabbitmq
    env: docker
    dockerfilePath: deploy/Dockerfile.rabbitmq
    dockerContext: .
    envVars:
      - key: RABBITMQ_DEFAULT_USER
        value: guest
      - key: RABBITMQ_DEFAULT_PASS
        value: guest

  # -------------------------------------------------------
  # 4. REDIS (Private Docker Service - Ephemeral)
  # -------------------------------------------------------
  - type: pserv
    name: postificus-redis
    env: docker
    dockerfilePath: deploy/Dockerfile.redis
    dockerContext: .

databases:
  # -------------------------------------------------------
  # 5. MANAGED POSTGRESQL (Simplest for now)
  # -------------------------------------------------------
  - name: postificus-db
    databaseName: postificus
    user: postificus_admin
    plan: free # 90 days limit on free tier

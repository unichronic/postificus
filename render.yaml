services:
  # --------------------------------------------------------------------------------
  # 1. API Service (Web)
  # --------------------------------------------------------------------------------
  - type: web
    name: postificus-api
    env: docker
    dockerContext: .
    dockerfilePath: ./Dockerfile
    plan: starter
    numInstances: 1
    dockerCommand: ./postificus-api # Override CMD
    envVars:
      - key: APP_ENV
        value: production
      - key: PORT
        value: 8080
      # External Services (User must provide connections)
      - key: DATABASE_URL
        sync: false # Supabase (postgres://...)
      - key: REDIS_URL
        sync: false # Redis Cloud (redis://...)
      - key: RABBITMQ_URL
        sync: false # CloudAMQP (amqps://...)
      # S3 / Object Storage
      - key: S3_ENDPOINT
        sync: false
      - key: S3_ACCESS_KEY
        sync: false
      - key: S3_SECRET_KEY
        sync: false
      - key: S3_BUCKET
        value: postificus-uploads
      - key: S3_PUBLIC_URL
        sync: false


  # --------------------------------------------------------------------------------
  # 2. Worker Service (Background)
  # --------------------------------------------------------------------------------
  - type: worker
    name: postificus-worker
    env: docker
    dockerContext: .
    dockerfilePath: ./Dockerfile
    plan: starter
    numInstances: 1
    dockerCommand: ./postificus-worker
    envVars:
      - key: APP_ENV
        value: production
      - key: BROWSER_HEADLESS
        value: "true"
      # External Services
      - key: DATABASE_URL
        sync: false
      - key: REDIS_URL
        sync: false
      - key: RABBITMQ_URL
        sync: false
      # S3
      - key: S3_ENDPOINT
        sync: false
      - key: S3_ACCESS_KEY
        sync: false
      - key: S3_SECRET_KEY
        sync: false
      - key: S3_BUCKET
        value: postificus

